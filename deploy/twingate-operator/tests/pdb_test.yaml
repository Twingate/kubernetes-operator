suite: PodDisruptionBudget
templates:
  - pdb.yaml
set:
  twingateOperator:
    network: <network slug>
    apiKey: <api key>
    remoteNetworkId: <remote network id>
tests:
  - it: should not create PDB when pdb.create is false
    set:
      pdb:
        create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create PDB with minAvailable when pdb.create is true
    set:
      pdb:
        create: true
        minAvailable: 1
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PodDisruptionBudget
      - equal:
          path: spec.minAvailable
          value: 1
      - isNull:
          path: spec.maxUnavailable

  - it: should create PDB with maxUnavailable when specified
    set:
      pdb:
        create: true
        maxUnavailable: "25%"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PodDisruptionBudget
      - equal:
          path: spec.maxUnavailable
          value: "25%"
      - isNull:
          path: spec.minAvailable

  - it: should have correct metadata
    set:
      pdb:
        create: true
        minAvailable: 1
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-twingate-operator
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - isNotEmpty:
          path: metadata.labels

  - it: should have correct selector labels
    set:
      pdb:
        create: true
        minAvailable: 1
    asserts:
      - isNotEmpty:
          path: spec.selector.matchLabels
      - equal:
          path: spec.selector.matchLabels['app.kubernetes.io/name']
          value: twingate-operator
      - equal:
          path: spec.selector.matchLabels['app.kubernetes.io/instance']
          value: RELEASE-NAME
